<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€… CRUD å®Œæ•´æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; border-radius: 3px; }
        .btn-danger { background: #dc3545; color: white; border: none; border-radius: 3px; }
        .btn-success { background: #28a745; color: white; border: none; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç®¡ç†è€… CRUD å®Œæ•´æ¸¬è©¦</h1>
    
    <div id="results"></div>
    
    <div class="test-section">
        <h3>æ¸¬è©¦æ§åˆ¶</h3>
        <button class="btn-primary" onclick="runFullCRUDTest()">åŸ·è¡Œå®Œæ•´ CRUD æ¸¬è©¦</button>
        <button class="btn-success" onclick="testCreate()">æ¸¬è©¦æ–°å¢ (C)</button>
        <button class="btn-primary" onclick="testRead()">æ¸¬è©¦è®€å– (R)</button>
        <button class="btn-primary" onclick="testUpdate()">æ¸¬è©¦æ›´æ–° (U)</button>
        <button class="btn-danger" onclick="testDelete()">æ¸¬è©¦åˆªé™¤ (D)</button>
        <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
    </div>
    
    <script>
        let testRecordId = null;
        let allVisitors = [];
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<p class="${className}">${message}</p>`;
            console.log(message);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function login() {
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'Woody' })
                });
                
                if (response.ok) {
                    log('âœ… ç®¡ç†å“¡ç™»å…¥æˆåŠŸ', 'success');
                    return true;
                } else {
                    log('âŒ ç®¡ç†å“¡ç™»å…¥å¤±æ•—', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ ç™»å…¥éŒ¯èª¤: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testCreate() {
            log('<h3>ğŸ†• æ¸¬è©¦æ–°å¢åŠŸèƒ½ (CREATE)</h3>');
            
            if (!await login()) return;
            
            testRecordId = new Date().toISOString() + '_test';
            const testData = {
                id: testRecordId,
                name: 'CRUD æ¸¬è©¦ç”¨æˆ¶',
                email: 'crud.test@example.com',
                phone: '0900123456',
                howDidYouHear: 'friend_family',
                howDidYouHearOther: '',
                isFirstVisit: 'yes',
                wantsContact: 'yes',
                prayerRequest: 'CRUD æ¸¬è©¦ä»£ç¦±äº‹é …'
            };
            
            try {
                const response = await fetch('/api/visitors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData),
                    credentials: 'include'
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    log('âœ… æ–°å¢åŠŸèƒ½æ­£å¸¸', 'success');
                    log(`å›æ‡‰: ${result}`);
                } else {
                    log('âŒ æ–°å¢åŠŸèƒ½å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${result}`);
                }
            } catch (error) {
                log(`âŒ æ–°å¢éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function testRead() {
            log('<h3>ğŸ“– æ¸¬è©¦è®€å–åŠŸèƒ½ (READ)</h3>');
            
            if (!await login()) return;
            
            try {
                const response = await fetch('/api/visitors', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allVisitors = await response.json();
                    log(`âœ… è®€å–åŠŸèƒ½æ­£å¸¸ï¼Œå…± ${allVisitors.length} ç­†è¨˜éŒ„`, 'success');
                    
                    if (allVisitors.length > 0) {
                        log('å‰ 3 ç­†è¨˜éŒ„:');
                        allVisitors.slice(0, 3).forEach((visitor, index) => {
                            log(`${index + 1}. ${visitor.name} (ID: ${visitor.id || 'ç„¡ID'})`);
                        });
                    }
                } else {
                    const errorText = await response.text();
                    log('âŒ è®€å–åŠŸèƒ½å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${errorText}`);
                }
            } catch (error) {
                log(`âŒ è®€å–éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function testUpdate() {
            log('<h3>âœï¸ æ¸¬è©¦æ›´æ–°åŠŸèƒ½ (UPDATE)</h3>');
            
            if (!await login()) return;
            
            // å¦‚æœæ²’æœ‰æ¸¬è©¦è¨˜éŒ„ï¼Œå…ˆç²å–ä¸€å€‹ç¾æœ‰è¨˜éŒ„
            if (!testRecordId && allVisitors.length === 0) {
                await testRead();
            }
            
            let targetRecord = null;
            if (testRecordId) {
                targetRecord = allVisitors.find(v => v.id === testRecordId);
            }
            
            if (!targetRecord && allVisitors.length > 0) {
                targetRecord = allVisitors.find(v => v.id && v.id !== '');
            }
            
            if (!targetRecord) {
                log('âŒ æ²’æœ‰æ‰¾åˆ°å¯æ›´æ–°çš„è¨˜éŒ„', 'error');
                return;
            }
            
            const updateData = {
                ...targetRecord,
                name: targetRecord.name + ' (å·²æ›´æ–°)',
                email: 'updated@example.com',
                prayerRequest: 'æ›´æ–°å¾Œçš„ä»£ç¦±äº‹é … - ' + new Date().toLocaleTimeString()
            };
            
            try {
                const response = await fetch('/api/visitors', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData),
                    credentials: 'include'
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    log(`âœ… æ›´æ–°åŠŸèƒ½æ­£å¸¸ (è¨˜éŒ„ ID: ${targetRecord.id})`, 'success');
                    log(`å›æ‡‰: ${result}`);
                } else {
                    log('âŒ æ›´æ–°åŠŸèƒ½å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${result}`);
                }
            } catch (error) {
                log(`âŒ æ›´æ–°éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function testDelete() {
            log('<h3>ğŸ—‘ï¸ æ¸¬è©¦åˆªé™¤åŠŸèƒ½ (DELETE)</h3>');
            
            if (!await login()) return;
            
            // å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œå…ˆç²å–
            if (allVisitors.length === 0) {
                await testRead();
            }
            
            // æ‰¾ä¸€å€‹æ¸¬è©¦è¨˜éŒ„ä¾†åˆªé™¤
            let targetRecord = null;
            if (testRecordId) {
                targetRecord = allVisitors.find(v => v.id === testRecordId);
            }
            
            // å¦‚æœæ²’æœ‰æ¸¬è©¦è¨˜éŒ„ï¼Œæ‰¾ä¸€å€‹åç¨±åŒ…å«"æ¸¬è©¦"çš„è¨˜éŒ„
            if (!targetRecord) {
                targetRecord = allVisitors.find(v => v.id && v.id !== '' && v.name && v.name.includes('æ¸¬è©¦'));
            }
            
            if (!targetRecord) {
                log('âŒ æ²’æœ‰æ‰¾åˆ°å¯åˆªé™¤çš„æ¸¬è©¦è¨˜éŒ„', 'error');
                log('å»ºè­°ï¼šå…ˆåŸ·è¡Œæ–°å¢æ¸¬è©¦å‰µå»ºæ¸¬è©¦è¨˜éŒ„');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨˜éŒ„ã€Œ${targetRecord.name}ã€å—ï¼Ÿ`)) {
                log('å–æ¶ˆåˆªé™¤æ¸¬è©¦');
                return;
            }
            
            try {
                const response = await fetch(`/api/visitors?id=${encodeURIComponent(targetRecord.id)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.text();
                
                if (response.ok) {
                    log(`âœ… åˆªé™¤åŠŸèƒ½æ­£å¸¸ (è¨˜éŒ„ ID: ${targetRecord.id})`, 'success');
                    log(`å›æ‡‰: ${result}`);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºè»Ÿåˆªé™¤
                    try {
                        const resultObj = JSON.parse(result);
                        if (resultObj.method === 'soft_delete') {
                            log('â„¹ï¸ ä½¿ç”¨è»Ÿåˆªé™¤æ–¹å¼ï¼ˆæ¨™è¨˜ç‚ºå·²åˆªé™¤ï¼‰', 'info');
                        }
                    } catch (e) {}
                } else {
                    log('âŒ åˆªé™¤åŠŸèƒ½å¤±æ•—', 'error');
                    log(`éŒ¯èª¤: ${result}`);
                }
            } catch (error) {
                log(`âŒ åˆªé™¤éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function runFullCRUDTest() {
            clearResults();
            log('<h2>ğŸš€ é–‹å§‹å®Œæ•´ CRUD æ¸¬è©¦</h2>');
            log('æ¸¬è©¦é †åºï¼šç™»å…¥ â†’ æ–°å¢ â†’ è®€å– â†’ æ›´æ–° â†’ åˆªé™¤');
            log('---');
            
            await testCreate();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testRead();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUpdate();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDelete();
            
            log('---');
            log('<h3>ğŸ‰ CRUD æ¸¬è©¦å®Œæˆï¼</h3>');
            log('è«‹æª¢æŸ¥ä¸Šè¿°çµæœï¼Œç¢ºä¿æ‰€æœ‰æ“ä½œéƒ½é¡¯ç¤º âœ…');
        }
    </script>
    
    <div class="test-section">
        <h3>ğŸ“‹ æ¸¬è©¦èªªæ˜</h3>
        <ul>
            <li><strong>æ–°å¢ (CREATE):</strong> å‰µå»ºä¸€ç­†æ¸¬è©¦è¨˜éŒ„</li>
            <li><strong>è®€å– (READ):</strong> ç²å–æ‰€æœ‰è¨ªå®¢è¨˜éŒ„</li>
            <li><strong>æ›´æ–° (UPDATE):</strong> ä¿®æ”¹æ¸¬è©¦è¨˜éŒ„çš„å…§å®¹</li>
            <li><strong>åˆªé™¤ (DELETE):</strong> åˆªé™¤æ¸¬è©¦è¨˜éŒ„ï¼ˆå¯èƒ½æ˜¯è»Ÿåˆªé™¤ï¼‰</li>
        </ul>
        
        <h4>é æœŸçµæœ</h4>
        <p>æ‰€æœ‰æ“ä½œéƒ½æ‡‰è©²é¡¯ç¤º âœ… æˆåŠŸæ¨™è¨˜ã€‚å¦‚æœæœ‰ âŒ éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ï¼š</p>
        <ul>
            <li>ç®¡ç†å“¡å¯†ç¢¼æ˜¯å¦æ­£ç¢º</li>
            <li>SheetDB URL æ˜¯å¦è¨­å®šæ­£ç¢º</li>
            <li>Google Sheets æ¬Šé™æ˜¯å¦æ­£ç¢º</li>
            <li>ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
        </ul>
    </div>
</body>
</html>